// Camden Photo Manager - Main Window
// Redesigned UI with tabbed navigation and dark/light theme

import { Button, LineEdit, ScrollView, ListView, CheckBox } from "std-widgets.slint";

// Import theme
import { Theme } from "components/theme.slint";

// Import components
import { TabBar } from "components/tab-bar.slint";
import { PhotoData } from "components/photo-card.slint";
import { PreviewModal } from "components/preview-modal.slint";

// Import views
import { ScanView } from "views/scan-view.slint";
import { DuplicatesView, DuplicateGroup, DuplicateStats } from "views/duplicates-view.slint";
import { GalleryView, GalleryStats } from "views/gallery-view.slint";
import { SettingsView } from "views/settings-view.slint";

// Re-export types for Rust backend
export { PhotoData, DuplicateGroup, DuplicateStats, GalleryStats }

// Legacy compatibility - keep FileData and GroupData for existing Rust code
export struct FileData {
    display_name: string,
    info: string,
    selected: bool,
    thumbnail: image,
    resolution_tier: int,
    moderation_tier: string,
    tags: string,
}

export struct GroupData {
    fingerprint: string,
    file_count: int,
    files: [FileData],
}

export component MainWindow inherits Window {
    width: 1400px;
    height: 900px;
    title: "Camden Photo Manager";
    background: Theme.colors.bg_primary;

    // Store window dimensions for responsive layouts
    property <length> content_width: self.width;

    // Navigation state
    in-out property <int> active-tab: 0;

    // Theme - dark mode by default
    in-out property <bool> dark_mode: true;

    // ===== SCAN VIEW PROPERTIES =====
    in-out property <string> root_path: "";
    in-out property <string> target_path: "";
    in-out property <bool> scanning: false;
    in-out property <float> scan_progress: 0.0;  // 0.0 to 1.0
    in-out property <bool> find_duplicates: true;
    in-out property <bool> rename_to_guid: false;
    in-out property <bool> detect_low_resolution: true;
    in-out property <bool> enable_classification: false;
    in-out property <bool> enable_feature_detection: true;
    in-out property <string> current_scan_file: "";
    in-out property <int> files_scanned: 0;
    in-out property <int> files_total: 0;
    in-out property <int> duplicates_found: 0;
    in-out property <int> low_res_found: 0;
    in-out property <string> last_scan_summary: "";
    in-out property <float> last_scan_duration: 0.0;

    // ===== DUPLICATES VIEW PROPERTIES =====
    in-out property <[DuplicateGroup]> duplicate_groups: [];
    in-out property <DuplicateStats> duplicate_stats: {
        total_groups: 0,
        total_files: 0,
        total_duplicates: 0,
        reclaimable_mb: 0.0,
        selected_count: 0,
    };
    in-out property <float> zoom_level: 100.0;

    // ===== GALLERY VIEW PROPERTIES =====
    in-out property <[PhotoData]> gallery_photos: [];
    in-out property <GalleryStats> gallery_stats: {
        total_photos: 0,
        filtered_photos: 0,
        selected_count: 0,
        landscape_count: 0,
        portrait_count: 0,
        square_count: 0,
    };
    // Gallery filters - individual properties
    in-out property <bool> filter_show_landscape: true;
    in-out property <bool> filter_show_portrait: true;
    in-out property <bool> filter_show_square: true;
    in-out property <bool> filter_show_high_res: true;
    in-out property <bool> filter_show_mobile_res: true;
    in-out property <bool> filter_show_low_res: true;
    in-out property <bool> filter_show_safe: true;
    in-out property <bool> filter_show_sensitive: true;
    in-out property <bool> filter_show_mature: true;
    in-out property <bool> filter_show_restricted: true;
    in-out property <string> filter_tag_search: "";
    in-out property <[{name: string, count: int}]> available_tags: [];

    // ===== SETTINGS VIEW PROPERTIES =====
    in-out property <string> settings_archive_path: "";
    in-out property <string> settings_cache_path: "";
    in-out property <bool> settings_show_tags: true;
    in-out property <bool> settings_compact_cards: false;
    in-out property <float> settings_cache_size_mb: 0.0;
    in-out property <int> settings_cached_thumbnails: 0;

    // ===== PREVIEW MODAL PROPERTIES =====
    in property <bool> show_preview_modal: false;
    in property <PhotoData> preview_photo: {
        id: -1,
        display_name: "",
        info: "",
        thumbnail: @image-url(""),
        selected: false,
        resolution_tier: 0,
        orientation: 0,
        moderation_tier: "",
        tags: "",
        aspect_ratio: "",
        is_keep_candidate: false,
        group_id: -1,
    };

    // ===== LEGACY PROPERTIES (for backward compatibility) =====
    in-out property <[GroupData]> groups: [];
    in-out property <string> status_text: "";

    // ===== CALLBACKS =====
    // Navigation
    callback tab-changed(int);

    // Scan view callbacks
    callback browse_root();
    callback browse_target();
    callback scan_requested();

    // Duplicates view callbacks
    callback file_toggled(int, int);
    callback move_requested();
    callback select_all_best();
    callback archive_selected();
    callback select_best_in_group(int);
    callback archive_others_in_group(int);

    // Gallery view callbacks
    callback gallery_photo_clicked(int);
    callback gallery_photo_toggle_selected(int);
    callback gallery_filter_changed();
    callback gallery_export_selected();
    callback gallery_archive_selected();
    callback gallery_select_all();
    callback gallery_deselect_all();

    // Preview modal callbacks
    callback preview_show_photo(int);
    callback preview_close();

    // Settings view callbacks
    callback browse_archive_path();
    callback browse_cache_path();
    callback clear_cache();
    callback save_settings();
    callback reset_defaults();

    // Sync theme with global
    changed dark_mode => {
        Theme.dark_mode = dark_mode;
    }

    // Initialize theme
    init => {
        Theme.dark_mode = dark_mode;
    }

    // Main layout
    VerticalLayout {
        // Tab bar
        TabBar {
            active-tab <=> active-tab;
            tab-changed(tab) => { tab-changed(tab); }
        }

        // Content area
        Rectangle {
            vertical-stretch: 1;
            clip: true;
            background: Theme.colors.bg_primary;

            // Scan View (tab 0)
            if active-tab == 0 : ScanView {
                root-path <=> root_path;
                find-duplicates <=> find_duplicates;
                classify-images <=> enable_classification;
                detect-low-res <=> detect_low_resolution;
                feature-detection <=> enable_feature_detection;
                rename-to-guid <=> rename_to_guid;
                scanning: scanning;
                progress: scan_progress;
                current-file: current_scan_file;
                files-scanned: files_scanned;
                files-total: files_total;
                duplicates-found: duplicates_found;
                low-res-found: low_res_found;
                last-scan-summary: last_scan_summary;
                last-scan-duration: last_scan_duration;

                browse-root => { browse_root(); }
                start-scan => { scan_requested(); }
            }

            // Duplicates View (tab 1)
            if active-tab == 1 : DuplicatesView {
                width: 100%;
                height: 100%;
                groups: duplicate_groups;
                stats: duplicate_stats;
                zoom-level <=> zoom_level;
                parent_width: content_width;

                file-toggled(gi, fi) => { file_toggled(gi, fi); }
                select-all-best => { select_all_best(); }
                archive-selected => { archive_selected(); }
                select-best-in-group(gi) => { select_best_in_group(gi); }
                archive-others-in-group(gi) => { archive_others_in_group(gi); }
            }

            // Gallery View (tab 2)
            if active-tab == 2 : GalleryView {
                width: 100%;
                height: 100%;
                photos: gallery_photos;
                stats: gallery_stats;
                show-landscape <=> filter_show_landscape;
                show-portrait <=> filter_show_portrait;
                show-square <=> filter_show_square;
                show-high-res <=> filter_show_high_res;
                show-mobile-res <=> filter_show_mobile_res;
                show-low-res <=> filter_show_low_res;
                show-safe <=> filter_show_safe;
                show-sensitive <=> filter_show_sensitive;
                show-mature <=> filter_show_mature;
                show-restricted <=> filter_show_restricted;
                tag-search <=> filter_tag_search;
                available-tags: available_tags;

                photo-clicked(idx) => { gallery_photo_clicked(idx); }
                photo-toggle-selected(idx) => { gallery_photo_toggle_selected(idx); }
                filter-changed => { gallery_filter_changed(); }
                export-selected => { gallery_export_selected(); }
                archive-selected => { gallery_archive_selected(); }
                select-all => { gallery_select_all(); }
                deselect-all => { gallery_deselect_all(); }
            }

            // Settings View (tab 3)
            if active-tab == 3 : SettingsView {
                archive-path <=> settings_archive_path;
                cache-path <=> settings_cache_path;
                show-tags <=> settings_show_tags;
                compact-cards <=> settings_compact_cards;
                cache-size-mb: settings_cache_size_mb;
                cached-thumbnails: settings_cached_thumbnails;
                dark-mode <=> dark_mode;

                browse-archive-path => { browse_archive_path(); }
                browse-cache-path => { browse_cache_path(); }
                clear-cache => { clear_cache(); }
                save-settings => { save_settings(); }
                reset-defaults => { reset_defaults(); }
            }
        }

        // Status bar
        Rectangle {
            height: 32px;
            background: Theme.colors.statusbar_bg;

            HorizontalLayout {
                padding-left: 16px;
                padding-right: 16px;
                spacing: 16px;

                Text {
                    text: status_text != "" ? status_text : "Ready";
                    font-size: 10pt;
                    color: Theme.colors.statusbar_text;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                if scanning : Text {
                    text: "Scanning...";
                    font-size: 10pt;
                    color: Theme.colors.accent_warning;
                    vertical-alignment: center;
                }
            }
        }

        // Preview modal overlay
        if show_preview_modal : PreviewModal {
            photo: preview_photo;
            close-requested => { preview_close(); }
        }
    }

}
